location:
  source_directories:
    {% for dir in backup.source_directories %}
    - {{ dir }}
    {% endfor %}
  repositories:
    - label: {{ backup.repository_host }}
      path: "ssh://{{ backup.repository_host }}/./borg/{{ inventory_hostname }}"
  exclude_patterns:
    {% for pattern in backup.exclude_patterns %}
    - {{ pattern }}
    {% endfor %}
  exclude_if_present:
    - .nobackup

storage:
  encryption_passphrase: "{{ backup.encryption_passphrase }}"

retention:
  keep_daily: {{ backup.retention.keep_daily | default(7) }}
  keep_weekly: {{ backup.retention.keep_weekly | default(4) }}

consistency:
  checks:
    - repository
    - archives

{% if backup.healthcheck_url is defined and backup.healthcheck_url %}
healthchecks:
  ping_url: {{ backup.healthcheck_url }}
{% endif %}

commands:
{% if backup.before_commands is defined and backup.before_commands %}
  - before: action
    run:
{% for cmd in backup.before_commands %}
      - {{ cmd }}
{% endfor %}
{% endif %}
{% if backup.after_commands is defined and backup.after_commands %}
  - after: action
    run:
{% for cmd in backup.after_commands %}
      - {{ cmd }}
{% endfor %}
{% endif %}
